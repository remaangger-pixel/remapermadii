<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Playing Video - Anvi Create</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg: #000000;
  --card: #0f0f0f;
  --accent: #ff0513;
  --text: #ffffff;
  --muted: #888888;
}

body {
  margin: 0; background: var(--bg); color: var(--text);
  font-family: 'Inter', sans-serif; overflow-x: hidden;
}

header {
  padding: 15px 5%; background: rgba(0,0,0,0.8);
  display: flex; align-items: center; gap: 15px;
  border-bottom: 1px solid #111;
}

.back-btn {
  background: #222; border: none; color: #fff;
  padding: 8px 15px; border-radius: 8px; cursor: pointer;
  font-weight: bold; transition: 0.3s;
}
.back-btn:hover { background: var(--accent); }

/* VIDEO CONTAINER */
.player-wrapper {
  width: 100%; max-width: 1100px; margin: 20px auto;
  padding: 0 15px; box-sizing: border-box;
}

.video-container {
  position: relative; width: 100%; padding-top: 56.25%; /* 16:9 Aspect Ratio */
  background: #080808; border-radius: 12px; overflow: hidden;
  box-shadow: 0 20px 50px rgba(0,0,0,0.8);
}

.video-container iframe {
  position: absolute; inset: 0; width: 100%; height: 100%; border: none;
}

/* INFO SECTION */
.video-info {
  margin-top: 25px; padding: 0 5%;
}

.video-info h1 {
  font-size: 26px; margin: 0 0 10px; font-weight: 800;
}

.meta-data {
  display: flex; align-items: center; gap: 15px; margin-bottom: 20px;
}

.tag {
  background: #1a1a1a; padding: 5px 12px; border-radius: 6px;
  font-size: 12px; color: var(--muted); border: 1px solid #222;
}

.desc {
  line-height: 1.6; color: #ccc; font-size: 15px; max-width: 800px;
}

/* ACTION BUTTONS */
.actions {
  display: flex; gap: 10px; margin-top: 20px;
}

.action-btn {
  background: #111; border: 1px solid #222; color: #fff;
  padding: 10px 20px; border-radius: 50px; cursor: pointer;
  font-size: 13px; transition: 0.3s;
}
.action-btn:hover { border-color: var(--accent); color: var(--accent); }

/* REKOMENDASI FILM */
.rekomendasi-container {
  margin-top: 40px; padding-bottom: 40px;
}
.rekomendasi-title {
  font-size: 18px; font-weight: bold; margin-bottom: 20px;
  border-left: 3px solid var(--accent); padding-left: 10px;
}
.grid-rekomendasi {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px;
}
.item-rekomendasi {
  background: var(--card); border-radius: 10px; overflow: hidden; cursor: pointer; transition: 0.3s;
}
.item-rekomendasi:hover { transform: scale(1.05); }
.item-rekomendasi img { width: 100%; aspect-ratio: 2/3; object-fit: cover; display: block; }
.item-rekomendasi p { padding: 8px; margin: 0; font-size: 12px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* SKELETON LOADING */
.loader {
  position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
  background: #000; z-index: 5; transition: 0.5s;
}
.spinner {
  width: 40px; height: 40px; border: 4px solid #333;
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

@media(max-width: 768px) {
  .video-info h1 { font-size: 20px; }
  .player-wrapper { padding: 0; }
  .video-container { border-radius: 0; }
  .grid-rekomendasi { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
}
</style>
</head>
<body>

<header>
  <button class="back-btn" onclick="history.back()">‚Üê Kembali</button>
  <span id="navTitle" style="color:var(--muted); font-size:14px">Memuat...</span>
</header>

<div class="player-wrapper">
  <div class="video-container">
    <div id="loader" class="loader"><div class="spinner"></div></div>
    <div id="playerFrame"></div>
  </div>
</div>

<div class="video-info">
  <div class="meta-data">
    <span class="tag" id="videoType">Video</span>
    <span class="tag">HD 1080p</span>
    <span class="tag" id="videoYear">2026</span>
  </div>
  <h1 id="title">Judul Video</h1>
  <p class="desc" id="description">Sedang memuat informasi video...</p>

  <div class="actions">
    <button class="action-btn" onclick="location.reload()">üîÑ Refresh Player</button>
    <button class="action-btn" onclick="alert('Terima kasih! Laporan dikirim ke admin.')">üö© Lapor Error</button>
    <button class="action-btn" onclick="shareVideo()">üîó Bagikan</button>
  </div>

  <div class="rekomendasi-container">
    <div class="rekomendasi-title">Mungkin Kamu Suka</div>
    <div class="grid-rekomendasi" id="suggestBox"></div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://xvktodveoxnuelhtzaog.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2a3RvZHZlb3hudWVsaHR6YW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NzEzMjAsImV4cCI6MjA4NTM0NzMyMH0.WUvB6oKtKxxgO-5z0SH8uBUQx9c3Gn6r170qxGeKWTI";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const params = new URLSearchParams(location.search);
const movieId = params.get("id");
const episodeId = params.get("episode");

async function loadContent() {
  if (movieId) {
    const { data, error } = await sb.from("Movies").select("*").eq("id", movieId).single();
    if (!error && data) {
      render(data.title, data.video, "Movie");
      loadSuggestions(data.id);
    }
  } else if (episodeId) {
    const { data, error } = await sb.from("Episodes").select("*, Series(title)").eq("id", episodeId).single();
    if (!error && data) {
      render(`${data.Series.title} - Eps ${data.episode}`, data.video, "Series");
      loadSuggestions(null); // Bisa dikembangkan untuk series terkait
    }
  } else {
    document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px;'>Video Tidak Ditemukan</h2>";
  }
}

function render(title, url, type) {
  document.title = title + " - Anvi Create";
  document.getElementById("navTitle").innerText = title;
  document.getElementById("title").innerText = title;
  document.getElementById("videoType").innerText = type;
  document.getElementById("description").innerText = `Kamu sedang menonton ${title}. Jika video macet atau tidak muncul, silakan klik tombol Refresh Player atau lapor ke admin kami.`;

  // Fix Google Drive Link
  let finalUrl = url.trim();
  if (finalUrl.includes("drive.google.com")) {
      finalUrl = finalUrl.replace("/view", "/preview");
  }

  const frame = document.getElementById("playerFrame");
  frame.innerHTML = `<iframe src="${finalUrl}" allowfullscreen allow="autoplay; fullscreen" referrerpolicy="no-referrer"></iframe>`;

  setTimeout(() => {
    const loader = document.getElementById("loader");
    if(loader) {
      loader.style.opacity = "0";
      setTimeout(() => loader.remove(), 500);
    }
  }, 1500);
}

async function loadSuggestions(currentId) {
  const { data } = await sb.from("Movies").select("*").eq("is18", false).neq("id", currentId).limit(8);
  const box = document.getElementById("suggestBox");
  if (data) {
    data.forEach(m => {
      box.innerHTML += `
        <div class="item-rekomendasi" onclick="location.href='player.html?id=${m.id}'">
          <img src="${m.thumb}">
          <p>${m.title}</p>
        </div>`;
    });
  }
}

function shareVideo() {
  navigator.clipboard.writeText(window.location.href);
  alert("Link video berhasil disalin ke clipboard!");
}

loadContent();
</script>

</body>
</html>
