<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Player</title>

<!-- SUPABASE CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Arial,sans-serif;
}
header{
  padding:12px 16px;
  background:#111;
  display:flex;
  align-items:center;
  gap:12px;
}
header button{
  background:#e50914;
  border:none;
  color:#fff;
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
}
.player{
  position:relative;
  width:100%;
  padding-top:56.25%;
  background:#000;
}
.player iframe{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  border:none;
}
.info{
  padding:16px;
}
.info h1{
  margin:0 0 8px 0;
  font-size:20px;
}
.info p{
  margin:0;
  color:#aaa;
  font-size:14px;
}
.block{
  padding:40px;
  text-align:center;
}
.block button{
  margin-top:16px;
  background:#e50914;
  border:none;
  color:#fff;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
}
</style>
</head>
<body>

<header>
  <button onclick="history.back()">‚Üê Back</button>
  <span id="headerTitle">Loading...</span>
</header>

<div id="content"></div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://xvktodveoxnuelhtzaog.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2a3RvZHZlb3hudWVsaHR6YW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NzEzMjAsImV4cCI6MjA4NTM0NzMyMH0.WUvB6oKtKxxgO-5z0SH8uBUQx9c3Gn6r170qxGeKWTI";

const sb = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ================= PARAM ================= */
const params = new URLSearchParams(location.search);
const movieId = params.get("id");
const episodeId = params.get("episode");

/* ================= ROUTER ================= */
if(movieId){
  loadMovie(movieId);
}else if(episodeId){
  loadEpisode(episodeId);
}else{
  showError("Video tidak ditemukan");
}

/* ================= LOAD MOVIE ================= */
async function loadMovie(id){
  const { data, error } = await sb
    .from("Movies")
    .select("*")
    .eq("id", id)
    .single();

  if(error || !data){
    showError("Video tidak ditemukan");
    return;
  }

  // üîû CEK 18+
  if(data.is18 === true && sessionStorage.getItem("adultAccess") !== "true"){
    showError("Konten 18+ terkunci<br>Masukkan kode terlebih dahulu");
    return;
  }

  renderPlayer({
    title: data.title,
    desc: data.type || "",
    video: data.video
  });
}

/* ================= LOAD EPISODE ================= */
async function loadEpisode(id){
  const { data: ep, error } = await sb
    .from("Episodes")
    .select(`
      id,
      episode,
      title,
      video_url,
      Series (
        title,
        is18
      )
    `)
    .eq("id", id)
    .single();

  if(error || !ep){
    showError("Episode tidak ditemukan");
    return;
  }

  // üîû CEK 18+
  if(ep.Series?.is18 === true && sessionStorage.getItem("adultAccess") !== "true"){
    showError("Konten 18+ terkunci<br>Masukkan kode terlebih dahulu");
    return;
  }

  renderPlayer({
    title: `${ep.Series.title} - EP ${ep.episode}`,
    desc: ep.title || "",
    video: ep.video_url
  });
}

/* ================= RENDER ================= */
function renderPlayer(v){
  document.title = v.title;
  document.getElementById("headerTitle").innerText = v.title;

  document.getElementById("content").innerHTML = `
    <div class="player">
      <iframe 
        src="${v.video}"
        allow="autoplay; fullscreen"
        allowfullscreen>
      </iframe>
    </div>

    <div class="info">
      <h1>${v.title}</h1>
      <p>${v.desc}</p>
    </div>
  `;
}

/* ================= ERROR ================= */
function showError(msg){
  document.getElementById("content").innerHTML = `
    <div class="block">
      <h2>${msg}</h2>
      <button onclick="history.back()">Kembali</button>
    </div>
  `;
}
</script>

</body>
</html>

