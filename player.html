<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Premium Player - Anvi Create</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root { --bg: #060606; --accent: #ff0513; --text: #ffffff; --muted: #888888; }

body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; }

/* HEADER - Kita turunkan z-index-nya agar tidak menimpa fullscreen */
header { 
  padding: 12px 5%; background: rgba(0,0,0,0.9); 
  display: flex; align-items: center; gap: 15px; 
  position: sticky; top: 0; z-index: 10; /* Z-index rendah */
  border-bottom: 1px solid #111; 
}

.back-btn { background: var(--accent); border: none; color: #fff; padding: 8px 18px; border-radius: 50px; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 13px; }

/* PLAYER WRAPPER */
.player-wrapper { width: 100%; max-width: 1100px; margin: 20px auto; padding: 0 15px; box-sizing: border-box; }

/* CONTAINER VIDEO - Penting: Kita beri z-index yang netral */
.video-container { 
  position: relative; width: 100%; padding-top: 56.25%; 
  background: #000; border-radius: 12px; 
  overflow: hidden; /* Pastikan tidak ada elemen keluar jalur */
  z-index: 1; 
}

/* IFRAME - Tambahkan properti Fullscreen khusus */
.video-container iframe { 
  position: absolute; inset: 0; width: 100%; height: 100%; border: none; 
  z-index: 5;
}

/* SERVER BOX */
.server-box { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
.btn-server { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; }
.btn-server.active { background: var(--accent); border-color: var(--accent); }

/* INFO */
.video-info { padding: 0 5%; margin-bottom: 40px; }
.tag { background: #1a1a1a; padding: 4px 10px; border-radius: 4px; font-size: 11px; color: var(--muted); margin-right: 10px; }

/* LOADER */
.loader { position: absolute; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 20; transition: 0.5s; pointer-events: none; }
.spinner { width: 40px; height: 40px; border: 4px solid #222; border-top-color: var(--accent); border-radius: 50%; animation: s 1s linear infinite; }
@keyframes s { to { transform: rotate(360deg); } }

/* PERBAIKAN MOBILE FULLSCREEN */
@media (max-width: 768px) {
  .player-wrapper { padding: 0; margin-top: 0; }
  .video-container { border-radius: 0; } /* Video full width di HP */
}
</style>
</head>
<body>

<header id="mainHeader">
  <a href="index.html" class="back-btn">âœ• Close</a>
  <span id="navTitle" style="color:var(--muted); font-size:13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Loading...</span>
</header>

<div class="player-wrapper">
  <div class="video-container" id="playerParent">
    <div id="loader" class="loader"><div class="spinner"></div></div>
    <div id="playerFrame"></div>
  </div>
  <div class="server-box" id="serverList"></div>
</div>

<div class="video-info">
  <div style="margin-bottom: 15px;"><span class="tag" id="vType">Video</span><span class="tag">Ultra HD</span></div>
  <h1 id="vTitle" style="margin:0 0 10px 0; font-size: 22px;">...</h1>
  <p id="vDesc" style="color:#aaa; font-size:14px;">Ganti server jika video lambat atau tidak muncul.</p>
</div>

<script>
const SUPABASE_URL = "https://xvktodveoxnuelhtzaog.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2a3RvZHZlb3hudWVsaHR6YW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NzEzMjAsImV4cCI6MjA4NTM0NzMyMH0.WUvB6oKtKxxgO-5z0SH8uBUQx9c3Gn6r170qxGeKWTI";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const params = new URLSearchParams(location.search);
const movieId = params.get("id");
const epsId = params.get("eps");

async function init() {
  let videoData = null;
  if (movieId) {
    const { data } = await sb.from("Movies").select("*").eq("id", movieId).maybeSingle();
    videoData = data;
    if(data) renderUI(data.title, "Movie");
  } else if (epsId) {
    const { data } = await sb.from("Episodes").select("*, Series(title)").eq("id", epsId).maybeSingle();
    videoData = data;
    if(data) renderUI(`${data.Series.title} - Eps ${data.episode}`, "Series");
  }

  if (videoData) {
    setupServers(videoData.video, videoData.video2);
  } else {
    location.href = "index.html";
  }
}

function renderUI(title, type) {
  document.getElementById("navTitle").innerText = "Watching: " + title;
  document.getElementById("vTitle").innerText = title;
  document.getElementById("vType").innerText = type;
}

function setupServers(s1, s2) {
  const serverBox = document.getElementById("serverList");
  serverBox.innerHTML = "";
  const servers = [];
  if (s1 && s1.trim()) servers.push({ name: "Server 1", url: s1.trim() });
  if (s2 && s2.trim()) servers.push({ name: "Server 2", url: s2.trim() });

  servers.forEach((srv, index) => {
    const btn = document.createElement("button");
    btn.className = "btn-server" + (index === 0 ? " active" : "");
    btn.innerText = srv.name;
    btn.onclick = () => {
      loadVideo(srv.url);
      document.querySelectorAll('.btn-server').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    };
    serverBox.appendChild(btn);
  });
  if (servers.length > 0) loadVideo(servers[0].url);
}

function loadVideo(url) {
  const frame = document.getElementById("playerFrame");
  const loader = document.getElementById("loader");
  const cleanUrl = url.replace(/,$/, "").trim();
  
  loader.style.opacity = "1";
  
  // ATRIBUT PENTING: allow="fullscreen" dan allowfullscreen tanpa nilai
  frame.innerHTML = `
    <iframe 
      src="${cleanUrl}" 
      allowfullscreen 
      webkitallowfullscreen 
      mozallowfullscreen 
      allow="autoplay; fullscreen; encrypted-media; picture-in-picture"
      referrerpolicy="no-referrer">
    </iframe>`;
  
  setTimeout(() => { loader.style.opacity = "0"; }, 1500);
}

init();
</script>
</body>
</html>
