<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Playing - Anvi Create</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root { --bg: #060606; --card: #121212; --accent: #ff0513; --text: #ffffff; --muted: #888888; }
body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow-x: hidden; }
header { padding: 12px 5%; background: rgba(0,0,0,0.9); display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #111; }
.back-btn { background: var(--accent); border: none; color: #fff; padding: 8px 18px; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 13px; text-decoration: none; }
.player-wrapper { width: 100%; max-width: 1100px; margin: 20px auto; padding: 0 15px; }
.video-container { position: relative; width: 100%; padding-top: 56.25%; background: #000; border-radius: 12px; overflow: hidden; }
.video-container iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: none; }
.server-box { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
.srv-btn { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-size: 13px; }
.srv-btn.active { background: var(--accent); border-color: var(--accent); }
.video-info { padding: 0 5%; margin-bottom: 40px; }
.video-info h1 { font-size: clamp(20px, 4vw, 28px); margin: 20px 0 10px; }
.tag { background: #1a1a1a; padding: 4px 10px; border-radius: 4px; font-size: 11px; color: var(--muted); margin-right: 8px; }
.rec-section { padding: 0 5% 50px; }
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
.card { background: var(--card); border-radius: 8px; overflow: hidden; cursor: pointer; }
.card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
.loader { position: absolute; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 10; transition: 0.5s; }
.spinner { width: 40px; height: 40px; border: 4px solid #222; border-top-color: var(--accent); border-radius: 50%; animation: s 1s linear infinite; }
@keyframes s { to { transform: rotate(360deg); } }
@media(max-width: 768px) { .player-wrapper { padding: 0; margin: 0; } .video-container { border-radius: 0; } }
</style>
</head>
<body>

<header>
  <a href="index.html" class="back-btn">âœ• Close</a>
  <span id="navTitle" style="color:var(--muted); font-size:13px;">Loading...</span>
</header>

<div class="player-wrapper">
  <div class="video-container">
    <div id="loader" class="loader"><div class="spinner"></div></div>
    <div id="playerFrame"></div>
  </div>
</div>

<div class="video-info">
  <div class="meta">
    <span class="tag" id="vType">Video</span>
    <span class="tag">Ultra HD</span>
  </div>
  <h1 id="vTitle">Memuat...</h1>
  <div class="server-box" id="srvList"></div>
  <p id="vDesc" style="color:#aaa; font-size:14px;">Selamat menonton di Anvi Create!</p>
</div>

<div class="rec-section">
  <h3 style="border-left:3px solid var(--accent); padding-left:10px;">Mungkin Kamu Suka</h3>
  <div class="grid" id="recList"></div>
</div>

<script>
const SUPABASE_URL = "https://xvktodveoxnuelhtzaog.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2a3RvZHZlb3hudWVsaHR6YW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NzEzMjAsImV4cCI6MjA4NTM0NzMyMH0.WUvB6oKtKxxgO-5z0SH8uBUQx9c3Gn6r170qxGeKWTI";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const params = new URLSearchParams(location.search);
const movieId = params.get("id");
const episodeId = params.get("episode");

async function init() {
  let videoData = null;
  let finalTitle = "";

  if (movieId) {
    const { data } = await sb.from("Movies").select("*").eq("id", movieId).single();
    if (data) {
      videoData = data;
      finalTitle = data.title;
      document.getElementById("vType").innerText = "Movie";
    }
  } else if (episodeId) {
    // Relasi ke tabel Series untuk judul utama
    const { data, error } = await sb.from("Episodes").select("*, Series(title)").eq("id", episodeId).single();
    if (data) {
      videoData = data;
      finalTitle = `${data.Series.title} - Episode ${data.episode}`;
      document.getElementById("vType").innerText = "Series";
    }
  }

  if (videoData) {
    document.getElementById("navTitle").innerText = "Watching: " + finalTitle;
    document.getElementById("vTitle").innerText = finalTitle;
    
    const srvList = document.getElementById("srvList");
    const servers = [{n: "Server 1", u: videoData.video}];
    if(videoData.video2) servers.push({n: "Server 2", u: videoData.video2});

    servers.forEach((s, i) => {
      const b = document.createElement("button");
      b.className = "srv-btn" + (i === 0 ? " active" : "");
      b.innerText = s.n;
      b.onclick = () => { play(s.u); document.querySelectorAll('.srv-btn').forEach(btn => btn.classList.remove('active')); b.classList.add('active'); };
      srvList.appendChild(b);
    });
    play(videoData.video);
    loadRecs();
  } else {
    document.getElementById("vTitle").innerText = "Video tidak ditemukan.";
    setTimeout(() => { location.href = "index.html" }, 2000);
  }
}

function play(url) {
  const loader = document.getElementById("loader");
  if(loader) { loader.style.display = "flex"; loader.style.opacity = "1"; }
  let cleanUrl = url.trim().replace("/view", "/preview");
  document.getElementById("playerFrame").innerHTML = `<iframe src="${cleanUrl}" allowfullscreen allow="autoplay"></iframe>`;
  setTimeout(() => { if(loader) { loader.style.opacity = "0"; setTimeout(() => loader.style.display = "none", 500); } }, 1500);
}

async function loadRecs() {
  const { data } = await sb.from("Movies").select("*").eq("is18", false).limit(6);
  const grid = document.getElementById("recList");
  data?.forEach(r => {
    grid.innerHTML += `<div class="card" onclick="location.href='player.html?id=${r.id}'"><img src="${r.thumb}"><div style="padding:8px;font-size:12px;text-align:center">${r.title}</div></div>`;
  });
}
init();
</script>
</body>
</html>
